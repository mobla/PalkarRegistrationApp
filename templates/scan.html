<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bay Area Diwali 2025 QR Scanner</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Quicksand", sans-serif;
      background: linear-gradient(rgba(255, 200, 150, 0.5), rgba(255, 170, 120, 0.5)),
                  url('/static/images/diwali-7.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff8dc;
      text-align: center;
      overflow-x: hidden;
    }

    header {
      padding: 2rem 1rem;
    }

    header h1 {
      font-size: 2.5rem;
      margin-top: 12vh;
      font-weight: bold;
      color: #8b0000;
      text-shadow: 2px 2px 5px #ffd700;
    }

    #reader {
      width: 90%;
      max-width: 500px;
      margin: 2rem auto;
      border: 6px solid #ffd700;
      border-radius: 20px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      background: rgba(255, 255, 255, 0.9);
    }

    #result {
      margin: 2rem auto;
      padding: 1rem;
      max-width: 500px;
      border-radius: 15px;
      font-size: 1.2rem;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    #result.success { background: #d4edda; color: #155724; }
    #result.error { background: #f8d7da; color: #721c24; }
    #result.info { background: #fff3cd; color: #856404; }

    /* Headcount selection */
    #attendee-selection {
      display: none;
      margin: 1.5rem auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      padding: 1.2rem;
      max-width: 400px;
      color: #3b1f0d;
    }

    select {
      font-size: 1.1rem;
      padding: 0.4rem;
      border-radius: 8px;
      border: 2px solid #ffa500;
      margin: 0.5rem;
    }

    button {
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      color: #4b0000;
      font-weight: 700;
      font-size: 1rem;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25), 0 0 12px #ffcc00;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    button:hover {
      transform: translateY(-2px) scale(1.05);
      background: linear-gradient(135deg, #ffcc33, #ff6600);
    }

    nav {
      margin: 2rem 0;
      display: flex;
      justify-content: center;
      gap: 1.2rem;
    }

    nav a {
      display: inline-block;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      color: #4b0000;
      font-weight: 700;
      font-size: 1rem;
      padding: 0.7rem 1.4rem;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25), 0 0 12px #ffcc00;
      text-decoration: none;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    nav a:hover {
      background: linear-gradient(135deg, #ffcc33, #ff6600);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 18px rgba(0,0,0,0.35), 0 0 18px #ff9900;
      color: #4b0000;
    }

    footer {
      margin-top: 3rem;
      padding: 1rem;
      font-size: 0.9rem;
      color: #3b1f0d;
    }

    #rescan-btn {
      display: none;
      margin: 1rem auto;
    }

    @media (max-width: 768px) {
      header h1 { font-size: 2rem; margin-top: 8vh; }
      #reader { width: 95%; }
      #result { font-size: 1rem; }
    }
  </style>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <header>
    <h1>ü™î‚ú® Bay Area Diwali 2025 QR Code Scanner ‚ú®ü™î</h1>
  </header>

  <div id="reader"></div>
  <div id="result" class="info">Scan a QR Code to check in</div>

  <div id="attendee-selection">
    <p><strong>Select number of attendees to check in:</strong></p>
    <select id="headcount"></select>
    <button id="submit-headcount">‚úÖ Confirm Check-In</button>
  </div>

  <button id="rescan-btn">üîÑ Rescan</button>

  <nav>
    <a href="/">üè† Home</a>
    <a href="/admin">‚öôÔ∏è Admin</a>
  </nav>

  <footer>
    <p>üå∏ QR Scanner ‚Ä¢ Developed by Obla Family ‚Ä¢ With Blessings üôè</p>
  </footer>

  <script>
    let scanner = null;
    let isScanning = false;

    function showResult(message, type) {
      const resultBox = document.getElementById("result");
      resultBox.className = type;
      resultBox.innerHTML = message;
    }

    function startScanner() {
      if (isScanning) return;

      const readerElem = document.getElementById("reader");
      readerElem.innerHTML = "";

      scanner = new Html5Qrcode("reader");
      isScanning = true;

      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          stopScanner().then(() => verifyQRCode(qrCodeMessage));
        },
        () => {}
      ).catch(err => {
        console.error("Unable to start scanning:", err);
        isScanning = false;
      });
    }

    function stopScanner() {
      if (scanner) {
        return scanner.stop().then(() => { isScanning = false; })
          .catch(err => { console.warn("Failed to stop scanner:", err); isScanning = false; });
      }
      return Promise.resolve();
    }

    function verifyQRCode(qr_id) {
      fetch(`/verify?qr_id=${qr_id}`)
        .then(res => res.json())
        .then(data => {
          if (data.status === "error") {
            showResult(data.message, 'error');
            setTimeout(startScanner, 1000);
            return;
          }

          showResult(`Attendee: ${data.name} | Total Registered: ${data.party_count}`, 'info');

          /*const select = document.getElementById('headcount');
          select.innerHTML = '';
          for (let i = 1; i <= data.party_count; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.text = i;
            select.appendChild(option);
          }*/

            const select = document.getElementById('headcount');
            select.innerHTML = '';

            for (let i = 1; i <= data.party_count; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.text = i;
            if (i === data.party_count) {
                option.selected = true; // ‚úÖ Preselect the party count
            }
            select.appendChild(option);
            }


          const selectionDiv = document.getElementById('attendee-selection');
          selectionDiv.style.display = 'block';
          document.getElementById('rescan-btn').style.display = 'none';

          document.getElementById('submit-headcount').onclick = () => {
            const count = parseInt(select.value);
            fetch(`/update_checkin?qr_id=${qr_id}&headcount=${count}`, { method: 'POST' })
              .then(res => res.json())
              .then(updateData => {
                if (updateData.status === "success") {
                  showResult(`‚úÖ Checked in ${count} attendees for ${data.name}`, 'success');
                } else {
                  showResult(updateData.message || 'Failed to update', 'error');
                }
                selectionDiv.style.display = 'none';
                document.getElementById('rescan-btn').style.display = 'inline-block';
              });
          };
        })
        .catch(err => {
          console.error("Verify error:", err);
          showResult('Scan failed', 'error');
          setTimeout(startScanner, 1500);
        });
    }

    // Rescan button logic
    document.getElementById('rescan-btn').onclick = () => {
      document.getElementById('rescan-btn').style.display = 'none';
      startScanner();
    };

    document.addEventListener("DOMContentLoaded", startScanner);
  </script>
</body>
</html>